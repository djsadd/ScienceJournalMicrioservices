# Обновление системы версионирования статей

## Изменения

Система версионирования статей была обновлена для хранения **полного снимка статьи** вместо только ссылки на файл.

## Что изменилось

### 1. Модель `ArticleVersion` (`models.py`)
Теперь хранит полный снимок статьи на момент создания версии:

**Добавленные поля:**
- `title_kz`, `title_en`, `title_ru` - заголовки на трех языках
- `abstract_kz`, `abstract_en`, `abstract_ru` - аннотации
- `doi` - идентификатор DOI
- `article_type` - тип статьи (original/review)
- `manuscript_file_url` - основной файл рукописи
- `antiplagiarism_file_url` - файл проверки на плагиат
- `author_info_file_url` - информация об авторах
- `cover_letter_file_url` - сопроводительное письмо
- `not_published_elsewhere`, `plagiarism_free`, `authors_agree` - булевы флаги
- `generative_ai_info` - информация об использовании AI

**Новые связи:**
- `authors` - список авторов версии (через `article_version_authors`)
- `keywords` - список ключевых слов версии (через `article_version_keywords`)

### 2. Схемы данных (`schemas.py`)
`ArticleVersionOut` теперь возвращает:
- Все поля статьи на момент создания версии
- Список авторов
- Список ключевых слов
- Полную информацию о файлах

### 3. API эндпоинты (`articles_router.py`)

**Новая функция:** `_create_article_version_snapshot()`
- Создает полный снимок статьи
- Копирует все данные, включая авторов и ключевые слова
- Используется при обновлении статьи и создании версий

**Обновленные эндпоинты:**
- `PUT /articles/{article_id}` - автоматически создает полную версию при обновлении
- `POST /articles/{article_id}/versions` - создает полный снимок текущего состояния статьи

### 4. Миграция базы данных
Файл: `alembic/versions/f02b17fc7620_add_full_article_snapshot_to_versions.py`

**Что делает миграция:**
1. Добавляет новые колонки в таблицу `article_versions`
2. Создает таблицы связей `article_version_authors` и `article_version_keywords`
3. Мигрирует существующие данные: копирует информацию из статей в версии
4. Копирует авторов и ключевые слова для существующих версий

## Применение миграции

```powershell
cd "Article Management Service"
alembic upgrade head
```

## Преимущества

✅ **Полная история изменений** - каждая версия содержит все данные статьи
✅ **Независимость версий** - изменения в текущей статье не влияют на прошлые версии
✅ **Точное восстановление** - можно точно увидеть статью в любой момент времени
✅ **Аудит и прозрачность** - полная история всех изменений (текст, авторы, ключевые слова)
✅ **Обратная совместимость** - сохранено поле `file_url` для старого API

## Примеры использования

### Создание версии при обновлении статьи
```python
PUT /articles/123
{
  "title_en": "Updated Title",
  "keyword_ids": [1, 2, 3]
}
```
→ Автоматически создается версия с полным снимком ОБНОВЛЕННОЙ статьи

### Создание версии вручную
```python
POST /articles/123/versions
```
→ Создается версия с полным снимком текущего состояния статьи

### Получение информации о версии
```python
GET /articles/my/123
```
→ Возвращает статью со всеми версиями, каждая версия содержит:
- Полные данные статьи на момент создания
- Список авторов
- Список ключевых слов
- Все файлы

## Обратная совместимость

- Поле `file_url` сохранено для обратной совместимости (дублирует `manuscript_file_url`)
- Старые версии автоматически мигрированы с копированием данных из статей
- API остается совместимым с предыдущими версиями
